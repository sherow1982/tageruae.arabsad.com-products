<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>منتجات تاجر الإمارات</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:'Tajawal',sans-serif;background:#f9fafb;margin:0;padding:0}
#products{padding-bottom:120px;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
.card{background:#fff;padding:10px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.08);transition:transform .15s; text-align:center;}
.card:hover{transform:scale(1.02)}
.product-image{width:100%;height:180px;object-fit:contain;cursor:pointer}
.shop-btn{position:sticky;bottom:20px;font-weight:bold;padding:10px;border-radius:50px;display:block;margin:10px auto;background:#00bfff;color:#fff;text-decoration:none;text-align:center;width:90%;}
.loading-msg{text-align:center;color:#555;font-weight:bold;margin-top:40px}
#search{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;margin-bottom:10px;font-weight:bold}
.badge{background:#FFD700;color:#000;font-weight:bold;padding:3px 6px;margin-top:5px;display:inline-block;border-radius:4px;font-size:.75rem}
</style>
</head>
<body class="p-3">

<h1 style="text-align:center;color:#0073e6;font-weight:bold;margin-bottom:10px;">منتجات تاجر الإمارات</h1>
<input type="text" id="search" placeholder="ابحث عن منتج...">
<div id="products"><p class="loading-msg">جارٍ تحميل المنتجات...</p></div>

<script>
const FEED_URL="https://api.easy-orders.net/api/v1/products/feed/437a38bb829245a3934e1d2fe153b417/channel/google";
const OLD_DOMAIN="https://tageruae.arabsad.com/";
const NEW_DOMAIN="https://tageruae.myeasyorders.com/";
const ITEMS_PER_LOAD=10;

let productsData=[], filteredData=[], currentIndex=0;

// جلب الفييد JSON مباشر
async function fetchFeed(){
    const res=await fetch(FEED_URL);
    if(!res.ok) throw new Error("Failed to fetch feed");
    const text=await res.text();
    const parser=new DOMParser();
    const xml=parser.parseFromString(text,"application/xml");
    const items=xml.querySelectorAll("item");
    const data=[];
    items.forEach(item=>{
        const title=item.querySelector("title")?.textContent||"منتج بدون اسم";
        const link=(item.querySelector("link")?.textContent||"#").replace(OLD_DOMAIN,NEW_DOMAIN);
        const image=item.querySelector("g\\:image_link, image_link")?.textContent||"";
        const price=parseFloat((item.querySelector("g\\:price, price")?.textContent||"0").replace(/[^\d.]/g,""))||0;
        data.push({title,link,image,price});
    });
    return data;
}

async function loadProducts(){
    const container=document.getElementById("products");
    container.innerHTML='<p class="loading-msg">جارٍ تحميل المنتجات...</p>';
    try{
        productsData=await fetchFeed();
        filteredData=[...productsData];
        currentIndex=0;
        container.innerHTML="";
        loadMoreItems();
    }catch(err){
        console.error(err);
        container.innerHTML='<p class="text-center" style="color:red;font-weight:bold">حدث خطأ في تحميل المنتجات.</p>';
    }
}

function createCard(prod){
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<a href="${prod.link}" target="_blank"><img data-src="${prod.image}" class="product-image lazy" alt="${prod.title}"></a>
    <h2 style="font-weight:bold;margin:.3rem 0">${prod.title}</h2>
    <span style="font-weight:bold;color:#006400;font-size:1rem">${prod.price} د.إ</span>
    <a href="${prod.link}" target="_blank" class="shop-btn">تسوق الآن</a>
    <div class="badge">شحن داخل الإمارات</div>`;
    return card;
}

function loadMoreItems(){
    const container=document.getElementById("products");
    const items=filteredData.slice(currentIndex,currentIndex+ITEMS_PER_LOAD);
    items.forEach(item=>container.appendChild(createCard(item)));
    currentIndex+=ITEMS_PER_LOAD;
    lazyLoadImages();
}

// البحث
document.getElementById("search").addEventListener("input",function(){
    const val=this.value.toLowerCase();
    filteredData=productsData.filter(p=>p.title.toLowerCase().includes(val));
    currentIndex=0;
    const container=document.getElementById("products");
    container.innerHTML="";
    loadMoreItems();
});

// Infinite Scroll
window.addEventListener("scroll",()=>{
    if((window.innerHeight+window.scrollY)>=document.body.offsetHeight-120 && currentIndex<filteredData.length){
        loadMoreItems();
    }
});

// Lazy Load
function lazyLoadImages(){
    const imgs=document.querySelectorAll("img.lazy");
    const observer=new IntersectionObserver((entries,obs)=>{
        entries.forEach(entry=>{
            if(entry.isIntersecting){
                entry.target.src=entry.target.dataset.src;
                entry.target.classList.remove("lazy");
                obs.unobserve(entry.target);
            }
        });
    },{rootMargin:"0px 0px 150px 0px",threshold:0});
    imgs.forEach(img=>observer.observe(img));
}

loadProducts();
</script>

<a href="https://wa.me/201110760081" target="_blank" class="shop-btn">راسلنا واتساب</a>

</body>
</html>
